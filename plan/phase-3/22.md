# TASK-022: Integrate Ordering & Loyalty into Page Configs

**Section**: 6. Direct Ordering, Loyalty, Offers, and Repeat Orders
**Subsection**: 6.2
**Task ID**: TASK-022

## Description

Extend page configuration builders (especially `build_restaurant_home_config`) to integrate ordering and loyalty features. This includes placing primary "Order Online" CTAs, optionally showing "More ways to order" with marketplace links, and adding loyalty/VIP capture modules.

**Reference Implementation**: 
- `menuhq/restaurant-finder/plan/phase-3/master-plan.md` (Sections 3.5, 3.6, 5.1)

## Current State

- OrderingConfig and LoyaltyConfig models exist (from TASK-021)
- RestaurantHomeConfig builder exists (from TASK-015)
- Other page builders exist (from TASK-016, TASK-017, etc.)
- No ordering/loyalty integration exists

**Prerequisites**: TASK-021, TASK-015 must be completed

## Checklist

### Preparation and Setup

- [ ] Review master plan Sections 3.5, 3.6, 5.1 for integration requirements
- [ ] Review RestaurantHomeConfig builder from TASK-015
- [ ] Understand CTA placement patterns
- [ ] Plan loyalty capture module structure

### Implementation Steps

- [ ] Step 1: Extend RestaurantHomeConfig builder
  - [ ] Modify `build_restaurant_home_config()` to accept `ordering_config: Optional[OrderingConfig]` and `loyalty_config: Optional[LoyaltyConfig]` parameters
  - [ ] Use ordering config to determine CTA placement
- [ ] Step 2: Integrate primary "Order Online" CTAs
  - [ ] Hero section primary CTA:
    - [ ] Use `ordering_config.direct_ordering_url` if available
    - [ ] Text: "Order Online" (or custom)
    - [ ] Make this the most prominent CTA
  - [ ] Sticky CTA (mobile/desktop):
    - [ ] Add sticky ordering CTA to config
    - [ ] Always visible, links to direct ordering
- [ ] Step 3: Integrate "More ways to order" section
  - [ ] If `ordering_config.show_marketplace_links` is True:
    - [ ] Create "More ways to order" section
    - [ ] Placement: Based on `ordering_config.marketplace_link_placement`
    - [ ] List marketplace links as secondary buttons or text links
    - [ ] De-emphasize visually (smaller, less prominent)
  - [ ] If False: Skip marketplace links entirely
- [ ] Step 4: Integrate loyalty/VIP capture modules
  - [ ] If `loyalty_config.enabled` is True:
    - [ ] Create loyalty capture section:
      - [ ] Headline: loyalty_config.program_name or "Join Our VIP Club"
      - [ ] Benefits list: loyalty_config.benefits
      - [ ] Signup form or CTA: links to loyalty_config.signup_url
      - [ ] Copy: loyalty_config.signup_copy
      - [ ] First order discount: loyalty_config.first_order_discount (if available)
    - [ ] Placement: Near hero or above footer (configurable)
    - [ ] Support email/SMS capture if enabled
- [ ] Step 5: Extend other page builders
  - [ ] Update `build_menu_page_config()` to include ordering CTAs
  - [ ] Update `build_location_page_config()` to include location-specific ordering
  - [ ] Update promo page builder to link to ordering flow
- [ ] Step 6: Add CTA section models
  - [ ] Create `OrderingCTASection` model for "More ways to order"
  - [ ] Create `LoyaltyCaptureSection` model for loyalty signup
- [ ] Step 7: Ensure CTAs are prominent
  - [ ] Primary CTAs use theme primary color
  - [ ] Primary CTAs are large and visible
  - [ ] Secondary CTAs are smaller and less prominent

### Specific Requirements

- [ ] Requirement 1: Primary "Order Online" CTAs are prominent
  - [ ] Hero CTA is primary action
  - [ ] Sticky CTA is always visible
  - [ ] Direct ordering is emphasized
- [ ] Requirement 2: Marketplace links are de-emphasized
  - [ ] Only shown if show_marketplace_links is True
  - [ ] Visually secondary to direct ordering
  - [ ] Placement is configurable
- [ ] Requirement 3: Loyalty modules are present when enabled
  - [ ] Capture modules appear on home page
  - [ ] Copy and benefits are displayed
  - [ ] Signup CTAs are clear

### Error Handling and Edge Cases

- [ ] Handle error case 1: Ordering config with no direct ordering URL
  - [ ] Use restaurant default or skip ordering CTAs
- [ ] Handle error case 2: Loyalty enabled but missing signup URL
  - [ ] Skip loyalty module or use placeholder
- [ ] Handle edge case 1: Restaurant with no ordering config
  - [ ] Use defaults (direct ordering enabled, no marketplace)
- [ ] Handle edge case 2: Restaurant with no loyalty config
  - [ ] Skip loyalty modules

### Testing

- [ ] Write unit tests: `tests/test_builders_ordering_loyalty.py`
  - [ ] Test RestaurantHomeConfig with ordering config (direct only)
  - [ ] Test RestaurantHomeConfig with ordering config (direct + marketplace)
  - [ ] Test primary "Order Online" CTAs are placed correctly
  - [ ] Test "More ways to order" section appears when show_marketplace_links is True
  - [ ] Test "More ways to order" section is omitted when show_marketplace_links is False
  - [ ] Test loyalty capture module appears when loyalty enabled
  - [ ] Test loyalty capture module has correct copy and benefits
  - [ ] Test restaurants without third-party links only show direct ordering CTAs
  - [ ] Test menu page includes ordering CTAs
  - [ ] Test location page includes location-specific ordering
- [ ] Run full test suite: `pytest tests/test_builders_ordering_loyalty.py`
- [ ] Verify test coverage: `pytest --cov=restaurant_site_planner.builders`

### Documentation

- [ ] Add docstrings to extended builder functions
- [ ] Document ordering and loyalty integration patterns
- [ ] Add examples of configs with ordering/loyalty

### Verification

- [ ] Verify primary CTAs are prominent
- [ ] Verify marketplace links are de-emphasized
- [ ] Verify loyalty modules work correctly
- [ ] Verify no regressions

## Notes

- This task is part of Phase 3: Owner.com-Aligned Restaurant Sites
- **Execution Timing**: After TASK-021
- **Dependencies**: 
  - TASK-021: Ordering and loyalty models
  - TASK-015: RestaurantHomeConfig builder
- **Important Considerations**: 
  - Direct ordering must be primary
  - Marketplace links must be secondary
  - Loyalty capture should be non-intrusive but visible
- **Task Independence**: Requires TASK-021 and TASK-015

## Related Tasks

- Previous: TASK-021 (Ordering & loyalty models)
- Next: TASK-023 (Repeat-order entry points)
- Dependencies:
  - TASK-021, TASK-015
- Related:
  - TASK-015: RestaurantHomeConfig builder
  - TASK-016: MenuPageConfig builder

## Definition of Done

### Task Type: CODE/FILE WRITING TASK

**User Stories**:
1. **As a restaurant owner**, I want primary "Order Online" CTAs so customers order directly from me
2. **As a developer**, I want ordering/loyalty integration so pages support all ordering scenarios
3. **As a customer**, I want clear ordering options so I can order easily

**Automated Tests**:
- [ ] Unit tests exist: `tests/test_builders_ordering_loyalty.py`
- [ ] All tests pass: `pytest tests/test_builders_ordering_loyalty.py` exits with code 0
- [ ] Tests verify restaurants with loyalty enabled have capture modules and correct copy
- [ ] Tests verify restaurants without third-party links only show direct ordering CTAs
- [ ] Test coverage >= 85%

**Code Quality**:
- [ ] Functions have type hints
- [ ] Integration is clean and maintainable
- [ ] Code follows Python style guidelines

**Git & Version Control**:
- [ ] All new files are added to git: `git add .`
- [ ] Changes are committed: `git commit -m "TASK-022: Integrate ordering & loyalty into page configs"`
- [ ] Code is pushed to origin: `git push origin <branch-name>`
- [ ] Commit message includes task ID: TASK-022

**Final Verification**:
- [ ] All checklist items completed
- [ ] All tests pass
- [ ] Ordering and loyalty are integrated correctly
- [ ] Code committed and pushed
