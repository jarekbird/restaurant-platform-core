# TASK-030: Design Contracts for Theme Extraction Pipeline

**Section**: 9. Optional: Owner.com Theme Extraction Pipeline
**Subsection**: 9.1
**Task ID**: TASK-030

## Description

Specify interfaces and contracts for the Owner.com theme extraction pipeline. This defines how the pipeline takes an Owner.com restaurant URL as input and produces a RestaurantTheme instance plus metadata about layout family. This is an optional feature for automatically extracting themes from Owner.com sites.

**Reference Implementation**: 
- `menuhq/restaurant-finder/plan/phase-3/master-plan.md` (Section 2.3)

## Current State

- RestaurantTheme model exists (from TASK-004)
- Theme families exist (from TASK-005)
- No extraction pipeline exists
- Need to design contracts and interfaces

**Prerequisites**: TASK-004, TASK-005 should be completed (for context)

## Checklist

### Preparation and Setup

- [ ] Review master plan Section 2.3 for extraction requirements
- [ ] Review RestaurantTheme model from TASK-004
- [ ] Review theme families from TASK-005
- [ ] Understand extraction pipeline architecture

### Implementation Steps

- [ ] Step 1: Design input interface
  - [ ] Define input contract:
    - [ ] `input_url: str` (required) - Owner.com restaurant URL
    - [ ] `extraction_options: Optional[Dict]` (optional) - extraction options
  - [ ] Document URL format requirements
  - [ ] Document validation rules
- [ ] Step 2: Design output interface
  - [ ] Define output contract:
    - [ ] `theme: RestaurantTheme` (required) - extracted theme
    - [ ] `layout_family: str` (required) - identified layout family
    - [ ] `confidence: float` (optional) - confidence score (0-1)
    - [ ] `metadata: Dict` (optional) - extraction metadata:
      - [ ] `extracted_at: datetime`
      - [ ] `source_url: str`
      - [ ] `extraction_method: str`
      - [ ] `raw_styles: Dict` (optional) - raw extracted styles
- [ ] Step 3: Design intermediate data format
  - [ ] Define style extraction format (JSON):
    - [ ] Colors: extracted color values
    - [ ] Typography: font families, sizes, weights
    - [ ] Spacing: spacing values
    - [ ] Shapes: border radii, shadows
    - [ ] Layout: layout patterns
  - [ ] Document JSON schema
  - [ ] Document field mappings
- [ ] Step 4: Design extraction pipeline stages
  - [ ] Stage 1: URL validation and page loading
  - [ ] Stage 2: Style extraction (CSS/computed styles)
  - [ ] Stage 3: Style mapping (raw styles â†’ RestaurantTheme)
  - [ ] Stage 4: Family classification
  - [ ] Stage 5: Validation and output
- [ ] Step 5: Create contract models
  - [ ] Create `src/restaurant_site_planner/extraction/` directory
  - [ ] Create `src/restaurant_site_planner/extraction/__init__.py`
  - [ ] Create `src/restaurant_site_planner/extraction/contracts.py`
  - [ ] Define `ExtractionInput` model
  - [ ] Define `ExtractionOutput` model
  - [ ] Define `RawStyleData` model
- [ ] Step 6: Document file formats
  - [ ] Document JSON format for raw style data
  - [ ] Document expected file structure
  - [ ] Add example JSON files
- [ ] Step 7: Create mock fixtures
  - [ ] Create `tests/fixtures/extraction/` directory
  - [ ] Add mock CSS/computed-style dumps for one Owner-style site
  - [ ] Add example raw style JSON files
  - [ ] Add expected output examples

### Specific Requirements

- [ ] Requirement 1: Contracts are well-defined
  - [ ] Input/output interfaces are clear
  - [ ] Data formats are documented
  - [ ] Validation rules are specified
- [ ] Requirement 2: Pipeline is modular
  - [ ] Stages are independent
  - [ ] Can be implemented in different languages (Node for Playwright, Python for mapping)
- [ ] Requirement 3: Output is valid
  - [ ] RestaurantTheme passes validation
  - [ ] Layout family is one of known families

### Error Handling and Edge Cases

- [ ] Handle error case 1: Invalid URL
  - [ ] Validation error with clear message
- [ ] Handle error case 2: Page not accessible
  - [ ] Error handling for network/timeout issues
- [ ] Handle edge case 1: Site with no clear theme
  - [ ] Low confidence score
  - [ ] Default theme or error

### Testing

- [ ] Write unit tests: `tests/test_extraction_contracts.py`
  - [ ] Test ExtractionInput validation
  - [ ] Test ExtractionOutput structure
  - [ ] Test RawStyleData format
  - [ ] Test mock responses/fixtures representing CSS/computed-style dumps for one Owner-style site
  - [ ] Test contract models serialize/deserialize
- [ ] Run full test suite: `pytest tests/test_extraction_contracts.py`
- [ ] Verify test coverage: `pytest --cov=restaurant_site_planner.extraction.contracts`

### Documentation

- [ ] Create `docs/theme-extraction.md`:
  - [ ] Overview of extraction pipeline
  - [ ] Input/output contracts
  - [ ] Data format specifications
  - [ ] Pipeline stages
  - [ ] Integration points
- [ ] Add docstrings to contract models
- [ ] Add examples of input/output

### Verification

- [ ] Verify contracts are well-defined
- [ ] Verify mock fixtures are realistic
- [ ] Verify documentation is complete
- [ ] Verify no regressions

## Notes

- This task is part of Phase 3: Owner.com-Aligned Restaurant Sites
- **Execution Timing**: Optional, can be done after core tasks
- **Dependencies**: 
  - TASK-004: RestaurantTheme model
  - TASK-005: Theme families
- **Important Considerations**: 
  - This is primarily a design/documentation task
  - Actual extraction implementation is separate (TASK-031, TASK-032)
  - Contracts must be stable
- **Task Independence**: Can be developed after TASK-004, TASK-005

## Related Tasks

- Previous: TASK-029 (End-to-end with promos/loyalty)
- Next: TASK-031 (Playwright extractor)
- Dependencies:
  - TASK-004, TASK-005
- Related:
  - TASK-031: Will implement Playwright extractor
  - TASK-032: Will implement LLM mapping

## Definition of Done

### Task Type: CODE/FILE WRITING TASK

**User Stories**:
1. **As a developer**, I want extraction contracts so I know how to implement the extraction pipeline
2. **As a developer**, I want mock fixtures so I can test extraction without live sites
3. **As a developer**, I want clear interfaces so extraction can be modular

**Automated Tests**:
- [ ] Unit tests exist: `tests/test_extraction_contracts.py`
- [ ] All tests pass: `pytest tests/test_extraction_contracts.py` exits with code 0
- [ ] Tests verify mock responses/fixtures representing CSS/computed-style dumps for one Owner-style site
- [ ] Test coverage >= 80%

**Code Quality**:
- [ ] Contract models are properly defined
- [ ] Documentation is complete
- [ ] Code follows Python style guidelines

**Git & Version Control**:
- [ ] All new files are added to git: `git add .`
- [ ] Changes are committed: `git commit -m "TASK-030: Design contracts for theme extraction pipeline"`
- [ ] Code is pushed to origin: `git push origin <branch-name>`
- [ ] Commit message includes task ID: TASK-030

**Final Verification**:
- [ ] All checklist items completed
- [ ] All tests pass
- [ ] Contracts are well-defined
- [ ] Code committed and pushed
