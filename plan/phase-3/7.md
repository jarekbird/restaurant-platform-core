# TASK-007: Implement URL Builder Utilities

**Section**: 2. URL & Routing Planning
**Subsection**: 2.1
**Task ID**: TASK-007

## Description

Implement URL builder utility functions that generate semantic, location-aware URL paths for all restaurant website pages. These functions will create SEO-friendly URLs following Owner.com patterns: `/restaurants/{city}/{restaurant-slug}/menu`, `/restaurants/{city}/{cuisine}`, etc.

The URL builders must implement stable, idempotent slugification rules that handle edge cases like accents, punctuation, and long names consistently.

**Reference Implementation**: 
- `menuhq/restaurant-finder/plan/phase-3/master-plan.md` (Section 4.1)

## Current State

- Restaurant models exist (from TASK-002)
- No URL builder utilities exist
- Need slugification logic for restaurant names, cities, cuisines
- Need path generation for all page types

**Prerequisites**: TASK-002 must be completed

## Checklist

### Preparation and Setup

- [ ] Review master plan Section 4.1 for URL patterns
- [ ] Research Python slugification libraries (e.g. `python-slugify`, `unidecode`)
- [ ] Plan slugification rules (lowercase, hyphens, remove special chars)
- [ ] Plan URL path structure

### Implementation Steps

- [ ] Step 1: Install slugification dependency
  - [ ] Add `python-slugify` or `unidecode` to `pyproject.toml`
  - [ ] Run `pip install -e .`
- [ ] Step 2: Create URL utilities module
  - [ ] Create `src/restaurant_site_planner/utils/` directory
  - [ ] Create `src/restaurant_site_planner/utils/__init__.py`
  - [ ] Create `src/restaurant_site_planner/utils/urls.py`
- [ ] Step 3: Implement slugification function
  - [ ] Add `slugify(text: str) -> str` function
  - [ ] Convert to lowercase
  - [ ] Remove/replace special characters
  - [ ] Replace spaces with hyphens
  - [ ] Handle accents (é → e, ñ → n)
  - [ ] Remove consecutive hyphens
  - [ ] Trim hyphens from start/end
  - [ ] Ensure idempotent (slugify(slugify(x)) == slugify(x))
  - [ ] Handle empty strings
  - [ ] Handle very long strings (truncate if needed)
- [ ] Step 4: Implement restaurant path builders
  - [ ] Add `restaurant_home_path(restaurant: Restaurant) -> str`
    - [ ] Returns: `/restaurants/{city-slug}/{restaurant-slug}`
    - [ ] Uses restaurant.slug or slugifies restaurant.name
    - [ ] Uses slugified city name
  - [ ] Add `restaurant_menu_path(restaurant: Restaurant) -> str`
    - [ ] Returns: `/restaurants/{city-slug}/{restaurant-slug}/menu`
  - [ ] Add `restaurant_catering_path(restaurant: Restaurant) -> str`
    - [ ] Returns: `/restaurants/{city-slug}/{restaurant-slug}/catering`
- [ ] Step 5: Implement index page path builders
  - [ ] Add `city_index_path(city: str) -> str`
    - [ ] Returns: `/restaurants/{city-slug}`
  - [ ] Add `cuisine_index_path(city: str, cuisine: str) -> str`
    - [ ] Returns: `/restaurants/{city-slug}/{cuisine-slug}`
- [ ] Step 6: Implement promo and news path builders
  - [ ] Add `promo_path(restaurant: Restaurant, campaign_slug: str) -> str`
    - [ ] Returns: `/restaurants/{city-slug}/{restaurant-slug}/promos/{campaign-slug}`
  - [ ] Add `news_post_path(restaurant: Restaurant, slug: str) -> str`
    - [ ] Returns: `/restaurants/{city-slug}/{restaurant-slug}/news/{slug}`

### Specific Requirements

- [ ] Requirement 1: Slugification is stable and idempotent
  - [ ] Same input always produces same output
  - [ ] Slugifying a slug produces the same slug
  - [ ] No random or time-based components
- [ ] Requirement 2: URLs are SEO-friendly
  - [ ] Lowercase
  - [ ] Hyphen-separated
  - [ ] No special characters
  - [ ] Readable (preserves word boundaries where possible)
- [ ] Requirement 3: Edge cases are handled
  - [ ] Accents are normalized
  - [ ] Punctuation is removed or replaced
  - [ ] Long names are handled (truncation if needed)
  - [ ] Empty strings are handled

### Error Handling and Edge Cases

- [ ] Handle error case 1: Empty restaurant name
  - [ ] Use slug if available, or raise error
- [ ] Handle error case 2: Empty city name
  - [ ] Raise validation error (city is required)
- [ ] Handle edge case 1: Accented characters
  - [ ] "Café" → "cafe"
  - [ ] "José's" → "joses"
- [ ] Handle edge case 2: Special characters
  - [ ] "Joe's Pizza & Grill" → "joes-pizza-grill"
  - [ ] "Restaurant (Downtown)" → "restaurant-downtown"
- [ ] Handle edge case 3: Very long names
  - [ ] Truncate to reasonable length (e.g. 100 chars)
  - [ ] Preserve word boundaries
- [ ] Handle edge case 4: Multiple spaces/consecutive hyphens
  - [ ] Collapse to single hyphen
- [ ] Handle edge case 5: Leading/trailing hyphens
  - [ ] Remove from start and end

### Testing

- [ ] Write unit tests: `tests/test_utils_urls.py`
  - [ ] Test `slugify()` with normal text
  - [ ] Test `slugify()` with accented characters
  - [ ] Test `slugify()` with special characters
  - [ ] Test `slugify()` with multiple spaces
  - [ ] Test `slugify()` idempotency
  - [ ] Test `slugify()` with empty string
  - [ ] Test `slugify()` with very long string
  - [ ] Test `restaurant_home_path()` with sample restaurant
  - [ ] Test `restaurant_menu_path()` with sample restaurant
  - [ ] Test `restaurant_catering_path()` with sample restaurant
  - [ ] Test `city_index_path()` with sample city
  - [ ] Test `cuisine_index_path()` with sample city and cuisine
  - [ ] Test `promo_path()` with sample restaurant and campaign
  - [ ] Test `news_post_path()` with sample restaurant and slug
  - [ ] Test exact expected paths for known inputs
  - [ ] Test edge cases: accents, punctuation, long names
- [ ] Run full test suite: `pytest tests/test_utils_urls.py`
- [ ] Verify test coverage: `pytest --cov=restaurant_site_planner.utils.urls`

### Documentation

- [ ] Add docstrings to all URL builder functions
- [ ] Document slugification rules
- [ ] Add examples of URL generation
- [ ] Document edge case handling

### Verification

- [ ] Verify slugification is idempotent
- [ ] Verify URLs match expected patterns
- [ ] Verify edge cases are handled
- [ ] Verify no regressions

## Notes

- This task is part of Phase 3: Owner.com-Aligned Restaurant Sites
- **Execution Timing**: After TASK-002, before TASK-008
- **Dependencies**: 
  - TASK-002: Restaurant models must exist
- **Important Considerations**: 
  - Slugification must be consistent across runs
  - URLs should be human-readable
  - Consider URL length limits
- **Task Independence**: Can be developed after TASK-002

## Related Tasks

- Previous: TASK-006 (Theme serialization)
- Next: TASK-008 (Internal linking planner)
- Dependencies:
  - TASK-002: Restaurant models
- Related:
  - TASK-008: Will use these URL builders
  - TASK-015: Will use URLs in page configs

## Definition of Done

### Task Type: CODE/FILE WRITING TASK

**User Stories**:
1. **As a developer**, I want URL builder functions so I can generate consistent, SEO-friendly URLs
2. **As a developer**, I want slugification that handles edge cases so URLs work for all restaurant names
3. **As a developer**, I want idempotent slugification so URLs are stable and predictable

**Automated Tests**:
- [ ] Unit tests exist: `tests/test_utils_urls.py`
- [ ] All tests pass: `pytest tests/test_utils_urls.py` exits with code 0
- [ ] Tests verify exact expected paths for sample restaurant names/cities/cuisines
- [ ] Tests for edge cases: accents, punctuation, long names
- [ ] Tests verify slugification is idempotent
- [ ] Test coverage >= 90%

**Code Quality**:
- [ ] All functions have type hints
- [ ] Slugification is idempotent
- [ ] Edge cases are handled
- [ ] Code follows Python style guidelines

**Git & Version Control**:
- [ ] All new files are added to git: `git add .`
- [ ] Changes are committed: `git commit -m "TASK-007: Implement URL builder utilities"`
- [ ] Code is pushed to origin: `git push origin <branch-name>`
- [ ] Commit message includes task ID: TASK-007

**Final Verification**:
- [ ] All checklist items completed
- [ ] All tests pass
- [ ] URL builders generate correct paths
- [ ] Slugification handles edge cases
- [ ] Code committed and pushed
