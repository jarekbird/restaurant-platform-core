# TASK-029: End-to-End Generation for Restaurant with Promos, Loyalty, and Community Events

**Section**: 8. Integration & End-to-End Scenarios
**Subsection**: 8.3
**Task ID**: TASK-029

## Description

Create a comprehensive end-to-end integration test that generates all page configs for a restaurant with loyalty program, active promo campaigns, and community/fundraising events. This validates that promotional content, loyalty features, and community engagement features work together correctly.

**Reference Implementation**: 
- `menuhq/restaurant-finder/plan/phase-3/master-plan.md` (Sections 3.6, 5.1, 5.2)

## Current State

- Promo page builder exists (from TASK-019)
- Community event builder exists (from TASK-020)
- Ordering/loyalty integration exists (from TASK-022)
- End-to-end tests exist (from TASK-027, TASK-028)
- Need sample data with promos/loyalty/events

**Prerequisites**: TASK-019, TASK-020, TASK-022, TASK-027 should be completed

## Checklist

### Preparation and Setup

- [ ] Review promo and community page builders
- [ ] Review ordering/loyalty integration
- [ ] Review end-to-end test patterns from TASK-027, TASK-028
- [ ] Plan sample data with promos, loyalty, events

### Implementation Steps

- [ ] Step 1: Create comprehensive sample fixture
  - [ ] Add `create_sample_restaurant_with_promos_loyalty_events() -> Tuple[Restaurant, Menu, OrderingConfig, LoyaltyConfig, List[Campaign], List[CommunityEvent]]` function
  - [ ] Restaurant with full data
  - [ ] Menu with categories and items
  - [ ] OrderingConfig with direct ordering enabled
  - [ ] LoyaltyConfig with program enabled:
    - [ ] Program name: "VIP Club"
    - [ ] First order discount: "10% off"
    - [ ] Benefits list
    - [ ] Signup URL
  - [ ] Active promo campaigns:
    - [ ] Campaign 1: "Summer Special" - active, 20% off
    - [ ] Campaign 2: "Holiday Menu" - upcoming
  - [ ] Community events:
    - [ ] Event 1: "Charity Night" - fundraising event
    - [ ] Event 2: "Community BBQ" - community engagement
- [ ] Step 2: Implement end-to-end test
  - [ ] Create `tests/integration/test_e2e_promos_loyalty_community.py`
  - [ ] Test function: `test_generate_restaurant_with_promos_loyalty_community_configs()`
  - [ ] Steps:
    - [ ] Load sample restaurant with all features
    - [ ] Build all page configs:
      - [ ] RestaurantHomeConfig (with loyalty integration)
      - [ ] MenuPageConfig
      - [ ] PromoPageConfig (for each campaign)
      - [ ] CommunityEventConfig (for each event)
    - [ ] Validate promo CTAs feed into ordering
    - [ ] Validate community content is linked and has metadata
    - [ ] Validate loyalty capture modules are present
- [ ] Step 3: Add detailed validations
  - [ ] Validate restaurant home page:
    - [ ] Loyalty capture module is present
    - [ ] Loyalty copy and benefits are displayed
    - [ ] Primary "Order Online" CTA is prominent
    - [ ] Promo offers are mentioned (if applicable)
  - [ ] Validate promo pages:
    - [ ] Promo page paths follow pattern
    - [ ] Strong CTA links to ordering flow
    - [ ] Promo details are displayed
    - [ ] SEO metadata is present
  - [ ] Validate community event pages:
    - [ ] Event details are displayed
    - [ ] Date/time information is present
    - [ ] Beneficiary information (if applicable)
    - [ ] CTA links to ordering or event page
    - [ ] SEO metadata is present
  - [ ] Validate loyalty integration:
    - [ ] Capture module appears on home page
    - [ ] Signup CTA is present
    - [ ] Benefits are listed
    - [ ] First order discount is mentioned
  - [ ] Validate ordering integration:
    - [ ] Primary CTAs link to direct ordering
    - [ ] Promo CTAs link to ordering with promo code (if applicable)
    - [ ] Marketplace links are de-emphasized (if present)

### Specific Requirements

- [ ] Requirement 1: Promo CTAs feed into ordering
  - [ ] Promo page CTAs link to ordering flow
  - [ ] Promo codes or parameters are included
  - [ ] Ordering flow can handle promo codes
- [ ] Requirement 2: Community content is linked
  - [ ] Community events are linked from home page
  - [ ] Event pages have proper metadata
  - [ ] Events are discoverable
- [ ] Requirement 3: Loyalty is integrated
  - [ ] Capture modules are present
  - [ ] Signup flow is accessible
  - [ ] Benefits are clear

### Error Handling and Edge Cases

- [ ] Handle edge case 1: Restaurant with no active promos
  - [ ] No promo pages generated
  - [ ] Home page doesn't mention promos
- [ ] Handle edge case 2: Restaurant with no community events
  - [ ] No event pages generated
- [ ] Handle edge case 3: Loyalty disabled
  - [ ] No loyalty modules on home page

### Testing

- [ ] Write integration test: `tests/integration/test_e2e_promos_loyalty_community.py`
  - [ ] Test `test_generate_restaurant_with_promos_loyalty_community_configs()`
  - [ ] Test builds promo pages, community event configs, and updated home
  - [ ] Test validates promo CTAs feed into ordering
  - [ ] Test validates community content is linked and has metadata
  - [ ] Test validates loyalty capture modules are present
  - [ ] Test validates promo pages have strong CTAs
  - [ ] Test validates event pages have proper metadata
  - [ ] Test configs serialize to JSON
- [ ] Run full test suite: `pytest tests/integration/test_e2e_promos_loyalty_community.py`
- [ ] Verify test coverage: `pytest --cov=restaurant_site_planner --cov-report=term-missing`

### Documentation

- [ ] Document comprehensive test structure
- [ ] Document sample data with all features
- [ ] Add examples of generated configs

### Verification

- [ ] Verify all page configs are generated
- [ ] Verify promos, loyalty, and events are integrated
- [ ] Verify CTAs link correctly
- [ ] Verify no regressions

## Notes

- This task is part of Phase 3: Owner.com-Aligned Restaurant Sites
- **Execution Timing**: After TASK-027, TASK-028
- **Dependencies**: 
  - TASK-019: Promo page builder
  - TASK-020: Community event builder
  - TASK-022: Ordering/loyalty integration
  - TASK-027: End-to-end test pattern
- **Important Considerations**: 
  - This validates advanced features
  - Promos and events should drive ordering
  - Loyalty should be non-intrusive but visible
- **Task Independence**: Requires dependencies

## Related Tasks

- Previous: TASK-028 (End-to-end multi-location)
- Next: TASK-030 (Theme extraction contracts)
- Dependencies:
  - TASK-019, TASK-020, TASK-022, TASK-027
- Related:
  - TASK-027, TASK-028: Similar test patterns

## Definition of Done

### Task Type: CODE/FILE WRITING TASK

**User Stories**:
1. **As a developer**, I want end-to-end tests with advanced features so I can validate promos, loyalty, and events work
2. **As a restaurant owner**, I want my promos and events to drive ordering so campaigns are effective
3. **As a customer**, I want clear promo and event information so I can participate and claim offers

**Automated Tests**:
- [ ] Integration test exists: `tests/integration/test_e2e_promos_loyalty_community.py`
- [ ] All tests pass: `pytest tests/integration/test_e2e_promos_loyalty_community.py` exits with code 0
- [ ] Test builds promo pages, community event configs, and updated home
- [ ] Test validates promo CTAs feed into ordering
- [ ] Test validates community content is linked and has metadata
- [ ] Test validates loyalty capture modules are present

**Code Quality**:
- [ ] Test fixtures are comprehensive
- [ ] Validations are thorough
- [ ] Code follows Python style guidelines

**Git & Version Control**:
- [ ] All new files are added to git: `git add .`
- [ ] Changes are committed: `git commit -m "TASK-029: End-to-end generation for restaurant with promos, loyalty, and community events"`
- [ ] Code is pushed to origin: `git push origin <branch-name>`
- [ ] Commit message includes task ID: TASK-029

**Final Verification**:
- [ ] All checklist items completed
- [ ] All tests pass
- [ ] Advanced features are validated
- [ ] Code committed and pushed
