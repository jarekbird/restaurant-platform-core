# TASK-023: Plan Repeat-Order Entry Points

**Section**: 6. Direct Ordering, Loyalty, Offers, and Repeat Orders
**Subsection**: 6.3
**Task ID**: TASK-023

## Description

Design and document configuration fields for repeat-order functionality. This includes reorder CTAs (for authenticated users) and deep-link parameters for pre-populated carts (from email/SMS campaigns). This supports Owner.com's pattern of frictionless repeat orders.

**Reference Implementation**: 
- `menuhq/restaurant-finder/plan/phase-3/master-plan.md` (Section 3.5)

## Current State

- Ordering config models exist (from TASK-021)
- Page builders exist (from TASK-015, TASK-022)
- No repeat-order configuration exists
- Need to design repeat-order data structures

**Prerequisites**: TASK-021, TASK-022 should be completed (for context)

## Checklist

### Preparation and Setup

- [ ] Review master plan Section 3.5 for repeat-order requirements
- [ ] Understand authenticated vs unauthenticated scenarios
- [ ] Plan deep-link parameter structure
- [ ] Plan previous order data structure

### Implementation Steps

- [ ] Step 1: Design PreviousOrder data model
  - [ ] Create `PreviousOrder` model with:
    - [ ] `order_id: str` (required)
    - [ ] `order_date: datetime` (required)
    - [ ] `items: List[OrderItem]` (required) - list of items from previous order
    - [ ] `total: float` (required)
    - [ ] `restaurant_id: str` (required)
  - [ ] Create `OrderItem` model with:
    - [ ] `menu_item_id: str` (required)
    - [ ] `name: str` (required)
    - [ ] `quantity: int` (required)
    - [ ] `price: float` (required)
    - [ ] `modifiers: Optional[List[Modifier]]` - extras, sizes, etc.
- [ ] Step 2: Design ReorderConfig model
  - [ ] Create `ReorderConfig` model with:
    - [ ] `enabled: bool` (required, default False)
    - [ ] `reorder_cta_text: str` (default "Reorder")
    - [ ] `reorder_cta_url_template: str` (required if enabled) - URL template with placeholders
    - [ ] `deep_link_enabled: bool` (default True)
    - [ ] `deep_link_parameters: Dict[str, str]` (optional) - parameter mapping
- [ ] Step 3: Design deep-link parameter structure
  - [ ] Document deep-link URL format: `/restaurants/{city}/{slug}/order?reorder={order_id}` or similar
  - [ ] Document parameter encoding (JSON, query params, etc.)
  - [ ] Document cart pre-population format
- [ ] Step 4: Implement reorder CTA generator
  - [ ] Add `build_reorder_cta(previous_order: PreviousOrder, reorder_config: ReorderConfig) -> CTAAction` function
  - [ ] Generate CTA with reorder URL
  - [ ] Include order summary in CTA text or tooltip
- [ ] Step 5: Implement deep-link builder
  - [ ] Add `build_reorder_deep_link(previous_order: PreviousOrder, reorder_config: ReorderConfig) -> str` function
  - [ ] Generate deep-link URL with parameters
  - [ ] Encode order data appropriately
- [ ] Step 6: Document integration points
  - [ ] Document where reorder CTAs appear (hero, nav, email/SMS)
  - [ ] Document how front-end consumes deep-links
  - [ ] Document cart pre-population format

### Specific Requirements

- [ ] Requirement 1: Reorder CTAs are well-formed
  - [ ] URLs are valid
  - [ ] Parameters are correctly encoded
  - [ ] CTAs are clear and actionable
- [ ] Requirement 2: Deep-links support pre-populated carts
  - [ ] Order items are encoded in URL or passed separately
  - [ ] Front-end can parse and populate cart
- [ ] Requirement 3: Configuration is flexible
  - [ ] Supports authenticated reorder (user's order history)
  - [ ] Supports unauthenticated deep-link (from email/SMS)

### Error Handling and Edge Cases

- [ ] Handle error case 1: Previous order with no items
  - [ ] Skip reorder or show "Order again" with empty cart
- [ ] Handle error case 2: Invalid order ID
  - [ ] Validation error or graceful fallback
- [ ] Handle edge case 1: Very large previous orders
  - [ ] Deep-link encoding handles large payloads
- [ ] Handle edge case 2: Items no longer available
  - [ ] Front-end handles unavailable items (not in planner scope)

### Testing

- [ ] Write unit tests: `tests/test_planners_reorder.py`
  - [ ] Test `build_reorder_cta()` with sample previous order
  - [ ] Test reorder CTA has correct URL and text
  - [ ] Test `build_reorder_deep_link()` with sample previous order
  - [ ] Test deep-link URL is well-formed
  - [ ] Test deep-link parameters are correctly encoded
  - [ ] Test PreviousOrder model validation
  - [ ] Test ReorderConfig model validation
  - [ ] Test sample "previous order" data structure can emit well-formed deep-link configuration
- [ ] Run full test suite: `pytest tests/test_planners_reorder.py`
- [ ] Verify test coverage: `pytest --cov=restaurant_site_planner.planners.reorder`

### Documentation

- [ ] Add docstrings to all functions and models
- [ ] Document repeat-order design and architecture
- [ ] Document deep-link format and parameters
- [ ] Document front-end integration requirements
- [ ] Add examples of reorder CTAs and deep-links

### Verification

- [ ] Verify reorder configuration is well-designed
- [ ] Verify deep-link format is clear
- [ ] Verify no regressions

## Notes

- This task is part of Phase 3: Owner.com-Aligned Restaurant Sites
- **Execution Timing**: After TASK-022
- **Dependencies**: 
  - TASK-021: Ordering config (for context)
  - TASK-022: Page builders (for context)
- **Important Considerations**: 
  - This is primarily a design/documentation task
  - Implementation will be consumed by future front-end
  - Deep-link format must be stable
- **Task Independence**: Can be developed after dependencies

## Related Tasks

- Previous: TASK-022 (Ordering & loyalty integration)
- Next: TASK-024 (Analytics event schema)
- Dependencies:
  - TASK-021, TASK-022 (for context)
- Related:
  - Future front-end tasks will consume this design

## Definition of Done

### Task Type: CODE/FILE WRITING TASK

**User Stories**:
1. **As a developer**, I want repeat-order configuration so I can support reorder functionality
2. **As a restaurant owner**, I want reorder CTAs so customers can easily order their favorites again
3. **As a customer**, I want easy reordering so I can quickly place repeat orders

**Automated Tests**:
- [ ] Unit tests exist: `tests/test_planners_reorder.py`
- [ ] All tests pass: `pytest tests/test_planners_reorder.py` exits with code 0
- [ ] Tests verify sample "previous order" data structure can emit well-formed deep-link configuration
- [ ] Test coverage >= 80%

**Code Quality**:
- [ ] Models are properly defined
- [ ] Functions have type hints
- [ ] Code follows Python style guidelines

**Git & Version Control**:
- [ ] All new files are added to git: `git add .`
- [ ] Changes are committed: `git commit -m "TASK-023: Plan repeat-order entry points"`
- [ ] Code is pushed to origin: `git push origin <branch-name>`
- [ ] Commit message includes task ID: TASK-023

**Final Verification**:
- [ ] All checklist items completed
- [ ] All tests pass
- [ ] Repeat-order design is documented
- [ ] Code committed and pushed
