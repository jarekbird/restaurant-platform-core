# TASK-021: Model Ordering & Loyalty Configuration

**Section**: 6. Direct Ordering, Loyalty, Offers, and Repeat Orders
**Subsection**: 6.1
**Task ID**: TASK-021

## Description

Create data models for ordering and loyalty configuration. These models define how restaurants handle direct ordering, third-party marketplace links, and loyalty/VIP programs. This supports the Owner.com pattern of emphasizing first-party ordering while optionally showing marketplace alternatives.

**Reference Implementation**: 
- `menuhq/restaurant-finder/plan/phase-3/master-plan.md` (Sections 3.5, 3.6)

## Current State

- Restaurant models exist (from TASK-002)
- No ordering or loyalty config models exist
- Need to define OrderingConfig and LoyaltyConfig models

**Prerequisites**: TASK-002 must be completed

## Checklist

### Preparation and Setup

- [ ] Review master plan Sections 3.5 and 3.6 for ordering/loyalty requirements
- [ ] Understand direct ordering vs marketplace patterns
- [ ] Plan OrderingConfig and LoyaltyConfig structure
- [ ] Understand loyalty program types

### Implementation Steps

- [ ] Step 1: Create ordering/loyalty models module
  - [ ] Create `src/restaurant_site_planner/models/ordering.py`
- [ ] Step 2: Implement OrderingConfig model
  - [ ] Define `OrderingConfig` class with:
    - [ ] `direct_ordering_enabled: bool` (required, default True)
    - [ ] `direct_ordering_url: str` (required if enabled)
    - [ ] `marketplace_links: Dict[str, str]` (optional) - e.g. {"doordash": "url", "ubereats": "url"}
    - [ ] `show_marketplace_links: bool` (default False) - whether to display marketplace links
    - [ ] `marketplace_link_placement: str` (optional) - "footer", "below-primary", "more-ways-to-order"
    - [ ] `pickup_enabled: bool` (default True)
    - [ ] `delivery_enabled: bool` (default False)
    - [ ] `reservations_enabled: bool` (default False)
    - [ ] `reservations_url: Optional[str]`
- [ ] Step 3: Implement LoyaltyConfig model
  - [ ] Define `LoyaltyConfig` class with:
    - [ ] `enabled: bool` (required, default False)
    - [ ] `program_name: str` (required if enabled) - e.g. "VIP Club", "Rewards Program"
    - [ ] `program_type: str` (required if enabled) - "points", "tier", "punch_card"
    - [ ] `signup_url: str` (required if enabled)
    - [ ] `signup_copy: str` (required if enabled) - marketing copy for signup
    - [ ] `benefits: List[str]` (optional) - list of benefits
    - [ ] `first_order_discount: Optional[str]` - e.g. "10% off"
    - [ ] `email_capture_enabled: bool` (default True)
    - [ ] `sms_capture_enabled: bool` (default False)
- [ ] Step 4: Add validation
  - [ ] OrderingConfig: direct_ordering_url required if direct_ordering_enabled
  - [ ] LoyaltyConfig: program fields required if enabled
  - [ ] Validate URLs are valid
- [ ] Step 5: Add helper methods
  - [ ] `OrderingConfig.has_marketplace_links() -> bool`
  - [ ] `LoyaltyConfig.is_active() -> bool`

### Specific Requirements

- [ ] Requirement 1: Configs support all scenarios
  - [ ] Only direct ordering
  - [ ] Direct + marketplace links
  - [ ] Loyalty program enabled/disabled
- [ ] Requirement 2: Validation is clear
  - [ ] Required fields are enforced
  - [ ] Invalid URLs raise errors
- [ ] Requirement 3: Models are serializable
  - [ ] Can serialize to JSON
  - [ ] Can parse from JSON

### Error Handling and Edge Cases

- [ ] Handle error case 1: Direct ordering enabled but no URL
  - [ ] Validation error
- [ ] Handle error case 2: Loyalty enabled but missing required fields
  - [ ] Validation error
- [ ] Handle edge case 1: Marketplace links but show_marketplace_links is False
  - [ ] Links stored but not displayed
- [ ] Handle edge case 2: Empty marketplace_links dict
  - [ ] No marketplace links available

### Testing

- [ ] Write unit tests: `tests/test_models_ordering.py`
  - [ ] Test OrderingConfig with only direct ordering
  - [ ] Test OrderingConfig with direct + marketplace links
  - [ ] Test OrderingConfig validation (direct_ordering_url required if enabled)
  - [ ] Test LoyaltyConfig with program enabled
  - [ ] Test LoyaltyConfig with program disabled
  - [ ] Test LoyaltyConfig validation (program fields required if enabled)
  - [ ] Test configs serialize to JSON
  - [ ] Test configs parse from JSON
  - [ ] Test helper methods
- [ ] Run full test suite: `pytest tests/test_models_ordering.py`
- [ ] Verify test coverage: `pytest --cov=restaurant_site_planner.models.ordering`

### Documentation

- [ ] Add docstrings to all models
- [ ] Document ordering and loyalty patterns
- [ ] Add examples of configs

### Verification

- [ ] Verify configs support all scenarios
- [ ] Verify validation works
- [ ] Verify serialization works
- [ ] Verify no regressions

## Notes

- This task is part of Phase 3: Owner.com-Aligned Restaurant Sites
- **Execution Timing**: After TASK-020
- **Dependencies**: 
  - TASK-002: Restaurant models (for context)
- **Important Considerations**: 
  - Direct ordering should be default and prominent
  - Marketplace links should be optional and de-emphasized
  - Loyalty programs should be easy to configure
- **Task Independence**: Can be developed after TASK-002

## Related Tasks

- Previous: TASK-020 (Community & news configs)
- Next: TASK-022 (Integrate ordering & loyalty into page configs)
- Dependencies:
  - TASK-002
- Related:
  - TASK-022: Will use these configs in page builders

## Definition of Done

### Task Type: CODE/FILE WRITING TASK

**User Stories**:
1. **As a developer**, I want ordering and loyalty config models so I can configure restaurant ordering options
2. **As a restaurant owner**, I want to configure direct ordering and marketplace links so I control my ordering channels
3. **As a developer**, I want loyalty program configs so I can enable VIP/rewards programs

**Automated Tests**:
- [ ] Unit tests exist: `tests/test_models_ordering.py`
- [ ] All tests pass: `pytest tests/test_models_ordering.py` exits with code 0
- [ ] Tests validate configs for restaurants with only direct ordering
- [ ] Tests validate configs for restaurants with direct + marketplace links
- [ ] Tests validate configs for restaurants with loyalty program enabled/disabled
- [ ] Test coverage >= 85%

**Code Quality**:
- [ ] All models use Pydantic BaseModel
- [ ] Validation logic is implemented
- [ ] Models serialize to JSON correctly
- [ ] Code follows Python style guidelines

**Git & Version Control**:
- [ ] All new files are added to git: `git add .`
- [ ] Changes are committed: `git commit -m "TASK-021: Model ordering & loyalty configuration"`
- [ ] Code is pushed to origin: `git push origin <branch-name>`
- [ ] Commit message includes task ID: TASK-021

**Final Verification**:
- [ ] All checklist items completed
- [ ] All tests pass
- [ ] Configs support all scenarios
- [ ] Code committed and pushed
