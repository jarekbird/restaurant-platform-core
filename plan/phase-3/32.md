# TASK-032: Implement LLM Mapping + Python Ingestion of Extracted Styles

**Section**: 9. Optional: Owner.com Theme Extraction Pipeline
**Subsection**: 9.3
**Task ID**: TASK-032

## Description

Add a Python function that takes raw style JSON (from TASK-031) and maps it into a valid RestaurantTheme via an LLM prompt (or heuristic rules if LLM not available). This completes the extraction pipeline by converting extracted styles into usable theme configurations.

**Reference Implementation**: 
- `menuhq/restaurant-finder/plan/phase-3/master-plan.md` (Section 2.3)
- TASK-030 contracts
- TASK-031 extractor output

## Current State

- Extraction contracts exist (from TASK-030)
- Playwright extractor exists (from TASK-031) or produces expected format
- RestaurantTheme model exists (from TASK-004)
- No style mapping exists

**Prerequisites**: TASK-030, TASK-031, TASK-004 must be completed

## Checklist

### Preparation and Setup

- [ ] Review TASK-030 contracts
- [ ] Review TASK-031 output format
- [ ] Review RestaurantTheme model from TASK-004
- [ ] Plan LLM prompt or heuristic rules
- [ ] Understand style mapping logic

### Implementation Steps

- [ ] Step 1: Create style mapping module
  - [ ] Create `src/restaurant_site_planner/extraction/mapper.py`
- [ ] Step 2: Implement raw style loader
  - [ ] Add `load_raw_style_data(file_path: str) -> RawStyleData` function
  - [ ] Parse JSON file from extractor
  - [ ] Validate against RawStyleData contract
- [ ] Step 3: Implement heuristic mapping (fallback)
  - [ ] Add `map_styles_heuristic(raw_styles: RawStyleData) -> RestaurantTheme` function
  - [ ] Map colors:
    - [ ] Extract primary, accent, background, surface colors
    - [ ] Infer from hero, buttons, navigation
  - [ ] Map typography:
    - [ ] Extract font families, sizes, weights
    - [ ] Map to heading_font, body_font
  - [ ] Map spacing:
    - [ ] Extract spacing values
    - [ ] Create spacing scale
  - [ ] Map shapes:
    - [ ] Extract border radii
    - [ ] Extract shadows
  - [ ] Map layout:
    - [ ] Infer layout patterns
- [ ] Step 4: Implement LLM mapping (if LLM available)
  - [ ] Add `map_styles_llm(raw_styles: RawStyleData, llm_client) -> RestaurantTheme` function
  - [ ] Create prompt:
    - [ ] Include raw style data
    - [ ] Include RestaurantTheme schema
    - [ ] Include theme family examples
    - [ ] Request theme mapping and family classification
  - [ ] Parse LLM response
  - [ ] Validate output against RestaurantTheme
- [ ] Step 5: Implement family classifier
  - [ ] Add `classify_theme_family(theme: RestaurantTheme) -> str` function
  - [ ] Compare theme to known families
  - [ ] Return best match or "custom"
- [ ] Step 6: Implement main mapping function
  - [ ] Add `map_extracted_styles(raw_style_file: str, use_llm: bool = False) -> Tuple[RestaurantTheme, str]` function
  - [ ] Load raw styles
  - [ ] Map to theme (LLM or heuristic)
  - [ ] Classify family
  - [ ] Return theme and family
- [ ] Step 7: Add validation
  - [ ] Validate mapped theme passes RestaurantTheme validation
  - [ ] Validate family is one of known families
  - [ ] Add confidence scoring

### Specific Requirements

- [ ] Requirement 1: Mapped themes are valid
  - [ ] Pass RestaurantTheme validation
  - [ ] All required fields are present
- [ ] Requirement 2: Family classification is accurate
  - [ ] Themes land in correct family
  - [ ] Or marked as "custom" if no match
- [ ] Requirement 3: Mapping is consistent
  - [ ] Same input produces similar output
  - [ ] LLM prompts are stable

### Error Handling and Edge Cases

- [ ] Handle error case 1: Invalid raw style file
  - [ ] Validation error
- [ ] Handle error case 2: LLM unavailable
  - [ ] Fall back to heuristic
- [ ] Handle edge case 1: Incomplete style data
  - [ ] Use defaults for missing fields
- [ ] Handle edge case 2: Unrecognized style patterns
  - [ ] Mark as "custom" family

### Testing

- [ ] Write unit tests: `tests/test_extraction_mapper.py`
  - [ ] Test `load_raw_style_data()` with sample file
  - [ ] Test `map_styles_heuristic()` with known style samples
  - [ ] Test mapped themes land in correct family and pass schema validation
  - [ ] Test `classify_theme_family()` with sample themes
  - [ ] Test `map_extracted_styles()` end-to-end
  - [ ] Test LLM mapping (if available) or mock
  - [ ] Test error handling
- [ ] Run full test suite: `pytest tests/test_extraction_mapper.py`
- [ ] Verify test coverage: `pytest --cov=restaurant_site_planner.extraction.mapper`

### Documentation

- [ ] Add docstrings to all functions
- [ ] Document mapping logic
- [ ] Document LLM prompt structure
- [ ] Add examples of mapped themes

### Verification

- [ ] Verify mapping works with sample data
- [ ] Verify themes are valid
- [ ] Verify family classification works
- [ ] Verify no regressions

## Notes

- This task is part of Phase 3: Owner.com-Aligned Restaurant Sites
- **Execution Timing**: Optional, after TASK-031
- **Dependencies**: 
  - TASK-030: Extraction contracts
  - TASK-031: Extractor output
  - TASK-004: RestaurantTheme model
- **Important Considerations**: 
  - LLM mapping is optional (heuristic fallback)
  - Mapping should be consistent
  - Family classification helps organize themes
- **Task Independence**: Requires dependencies

## Related Tasks

- Previous: TASK-031 (Playwright extractor)
- Next: TASK-033 (Prototype retrofit)
- Dependencies:
  - TASK-030, TASK-031, TASK-004
- Related:
  - TASK-004: RestaurantTheme model
  - TASK-005: Theme families

## Definition of Done

### Task Type: CODE/FILE WRITING TASK

**User Stories**:
1. **As a developer**, I want style mapping so I can convert extracted styles into themes
2. **As a developer**, I want LLM mapping so themes are accurately classified
3. **As a developer**, I want heuristic fallback so mapping works without LLM

**Automated Tests**:
- [ ] Unit tests exist: `tests/test_extraction_mapper.py`
- [ ] All tests pass: `pytest tests/test_extraction_mapper.py` exits with code 0
- [ ] Tests verify known style samples are mapped to correct family and pass schema validation
- [ ] Test coverage >= 80%

**Code Quality**:
- [ ] Functions have type hints
- [ ] Mapping logic is clear
- [ ] Code follows Python style guidelines

**Git & Version Control**:
- [ ] All new files are added to git: `git add .`
- [ ] Changes are committed: `git commit -m "TASK-032: Implement LLM mapping + Python ingestion of extracted styles"`
- [ ] Code is pushed to origin: `git push origin <branch-name>`
- [ ] Commit message includes task ID: TASK-032

**Final Verification**:
- [ ] All checklist items completed
- [ ] All tests pass
- [ ] Style mapping works correctly
- [ ] Code committed and pushed
