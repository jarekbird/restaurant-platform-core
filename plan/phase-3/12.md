# TASK-012: Implement Restaurant JSON-LD Generator

**Section**: 4. Structured Data (Schema.org)
**Subsection**: 4.1
**Task ID**: TASK-012

## Description

Implement a function that generates JSON-LD structured data (Schema.org) for restaurant pages. This includes Restaurant schema with all required fields: name, image, address, geo coordinates, cuisine, telephone, URL, hours, price range, ratings, and menu link.

This structured data makes restaurant information machine-readable for search engines and AI assistants, improving SEO and AI search visibility.

**Reference Implementation**: 
- `menuhq/restaurant-finder/plan/phase-3/master-plan.md` (Section 4.4)
- Schema.org Restaurant documentation

## Current State

- Restaurant models exist (from TASK-002)
- Location models exist (from TASK-002)
- No JSON-LD generators exist
- Need to create Schema.org-compliant structured data

**Prerequisites**: TASK-002 must be completed

## Checklist

### Preparation and Setup

- [ ] Review master plan Section 4.4 for schema requirements
- [ ] Review Schema.org Restaurant schema documentation
- [ ] Understand JSON-LD format and structure
- [ ] Plan field mappings from Restaurant model to Schema.org

### Implementation Steps

- [ ] Step 1: Create schema generator module
  - [ ] Create `src/restaurant_site_planner/generators/schema.py`
- [ ] Step 2: Implement restaurant schema builder
  - [ ] Add `build_restaurant_schema(restaurant: Restaurant, location: Optional[Location] = None) -> dict` function
  - [ ] Create base schema structure:
    - [ ] `@context: "https://schema.org"`
    - [ ] `@type: "Restaurant"` (or "FoodEstablishment" if more appropriate)
  - [ ] Add required fields:
    - [ ] `name`: restaurant.name
    - [ ] `image`: restaurant.hero_image_url or restaurant.logo_url
    - [ ] `address`: Format as PostalAddress object with:
      - [ ] `streetAddress`: restaurant.address
      - [ ] `addressLocality`: restaurant.city
      - [ ] `addressRegion`: restaurant.state
      - [ ] `postalCode`: restaurant.zip
      - [ ] `addressCountry`: restaurant.country or "US"
    - [ ] `geo`: GeoCoordinates object with:
      - [ ] `latitude`: restaurant.coordinates.lat
      - [ ] `longitude`: restaurant.coordinates.lon
    - [ ] `servesCuisine`: restaurant.cuisine or restaurant.cuisines (array)
    - [ ] `telephone`: restaurant.phone
    - [ ] `url`: restaurant.website or generated restaurant home URL
    - [ ] `openingHoursSpecification`: Array of OpeningHoursSpecification objects
      - [ ] Convert restaurant.hours dict to Schema.org format
      - [ ] Map days of week (mon, tue, etc.) to dayOfWeek enum
      - [ ] Parse time ranges (e.g. "11:00-21:00" → opens/closes)
    - [ ] `priceRange`: restaurant.price_range (e.g. "$$")
  - [ ] Add optional fields:
    - [ ] `aggregateRating`: If restaurant.rating exists:
      - [ ] `ratingValue`: restaurant.rating
      - [ ] `reviewCount`: restaurant.review_count
      - [ ] `bestRating`: 5
      - [ ] `worstRating`: 1
    - [ ] `menu`: Link to menu page URL (if menu exists)
- [ ] Step 3: Implement hours conversion
  - [ ] Add `convert_hours_to_schema(hours: Dict[str, str]) -> List[Dict]` helper
  - [ ] Map day abbreviations to Schema.org dayOfWeek values:
    - [ ] "mon" → "Monday", "tue" → "Tuesday", etc.
  - [ ] Parse time ranges:
    - [ ] "11:00-21:00" → opens: "11:00", closes: "21:00"
    - [ ] Handle "Closed" or empty values
    - [ ] Handle 24-hour format if needed
- [ ] Step 4: Implement address formatting
  - [ ] Add `format_address_for_schema(restaurant: Restaurant) -> Dict` helper
  - [ ] Create PostalAddress object with all available fields
  - [ ] Handle missing optional fields gracefully
- [ ] Step 5: Implement geo coordinates formatting
  - [ ] Add `format_geo_for_schema(restaurant: Restaurant) -> Optional[Dict]` helper
  - [ ] Create GeoCoordinates object if coordinates exist
  - [ ] Return None if coordinates missing

### Specific Requirements

- [ ] Requirement 1: Schema is Schema.org compliant
  - [ ] Uses correct @context and @type
  - [ ] Field names match Schema.org specification
  - [ ] Data types are correct (strings, numbers, objects, arrays)
- [ ] Requirement 2: All available data is included
  - [ ] Required fields are present when data exists
  - [ ] Optional fields are included when available
  - [ ] No null/None values in schema (omit fields instead)
- [ ] Requirement 3: Address format is valid
  - [ ] PostalAddress structure is correct
  - [ ] All address components are properly mapped

### Error Handling and Edge Cases

- [ ] Handle error case 1: Missing required restaurant data
  - [ ] Use defaults or omit fields gracefully
  - [ ] Don't include fields with None/null values
- [ ] Handle error case 2: Invalid hours format
  - [ ] Handle malformed time ranges
  - [ ] Handle "Closed" or empty hours
- [ ] Handle edge case 1: Restaurant with no coordinates
  - [ ] Omit geo field if coordinates missing
- [ ] Handle edge case 2: Restaurant with no hours
  - [ ] Omit openingHoursSpecification if hours missing
- [ ] Handle edge case 3: Multiple cuisines
  - [ ] Use array for servesCuisine if multiple
- [ ] Handle edge case 4: Missing price range
  - [ ] Omit priceRange field if not available

### Testing

- [ ] Write unit tests: `tests/test_generators_schema.py`
  - [ ] Test `build_restaurant_schema()` with full restaurant data
  - [ ] Test presence and correct mapping of all keys (@type, name, image, address, geo, servesCuisine, telephone, url, openingHoursSpecification, priceRange, aggregateRating, menu)
  - [ ] Test `@type` is "Restaurant"
  - [ ] Test address formats are valid (PostalAddress structure)
  - [ ] Test geo coordinates format (GeoCoordinates structure)
  - [ ] Test hours conversion to OpeningHoursSpecification
  - [ ] Test aggregateRating structure when rating exists
  - [ ] Test schema with minimal restaurant data (only required fields)
  - [ ] Test schema with missing optional fields (omitted, not null)
  - [ ] Test location parameter (uses location data if provided)
- [ ] Write integration tests
  - [ ] Test schema validates against Schema.org (if validator available)
  - [ ] Test schema can be embedded in HTML as JSON-LD
- [ ] Run full test suite: `pytest tests/test_generators_schema.py`
- [ ] Verify test coverage: `pytest --cov=restaurant_site_planner.generators.schema`

### Documentation

- [ ] Add docstrings to all schema generator functions
- [ ] Document Schema.org field mappings
- [ ] Add examples of generated schemas
- [ ] Document how to embed in HTML

### Verification

- [ ] Verify schema is Schema.org compliant
- [ ] Verify all fields are correctly mapped
- [ ] Verify schema can be embedded as JSON-LD
- [ ] Verify no regressions

## Notes

- This task is part of Phase 3: Owner.com-Aligned Restaurant Sites
- **Execution Timing**: After TASK-002
- **Dependencies**: 
  - TASK-002: Restaurant and Location models
- **Important Considerations**: 
  - Schema must be valid JSON-LD
  - Follow Schema.org Restaurant specification exactly
  - Omit fields with None/null values (don't include them)
  - Hours conversion is complex - test thoroughly
- **Task Independence**: Can be developed after TASK-002

## Related Tasks

- Previous: TASK-011 (Content checker)
- Next: TASK-013 (FAQ and Breadcrumb schemas)
- Dependencies:
  - TASK-002
- Related:
  - TASK-015: Will use restaurant schema in page configs

## Definition of Done

### Task Type: CODE/FILE WRITING TASK

**User Stories**:
1. **As an SEO specialist**, I want JSON-LD structured data so search engines understand restaurant information
2. **As a developer**, I want schema generators so I can create machine-readable restaurant data
3. **As an AI assistant**, I want structured data so I can answer questions about restaurants accurately

**Automated Tests**:
- [ ] Unit tests exist: `tests/test_generators_schema.py`
- [ ] All tests pass: `pytest tests/test_generators_schema.py` exits with code 0
- [ ] Tests verify presence and correct mapping of all keys for sample restaurant with full data
- [ ] Tests verify `@type` is "Restaurant" and address formats are valid
- [ ] Tests verify hours conversion works correctly
- [ ] Tests verify aggregateRating structure
- [ ] Test coverage >= 85%

**Code Quality**:
- [ ] Function has type hints
- [ ] Schema is Schema.org compliant
- [ ] Code follows Python style guidelines

**Git & Version Control**:
- [ ] All new files are added to git: `git add .`
- [ ] Changes are committed: `git commit -m "TASK-012: Implement Restaurant JSON-LD generator"`
- [ ] Code is pushed to origin: `git push origin <branch-name>`
- [ ] Commit message includes task ID: TASK-012

**Final Verification**:
- [ ] All checklist items completed
- [ ] All tests pass
- [ ] Schema is Schema.org compliant
- [ ] Code committed and pushed
