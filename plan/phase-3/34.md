# TASK-034: Iterative Refinement Loop

**Section**: 10. Prototype Retrofit
**Subsection**: 10.2
**Task ID**: TASK-034

## Description

Implement an iterative refinement process for pilot restaurant integrations. For each pilot restaurant, generate configs, compare with Owner.com-style expectations, and update mapping rules, templates, and tests as necessary.

This task establishes a feedback loop to continuously improve the site planner based on real-world usage and Owner.com alignment.

**Reference Implementation**: 
- `menuhq/restaurant-finder/plan/phase-3/master-plan.md` (Section 7.1)
- Previous pilot integration work (TASK-033)

## Current State

- Python outputs are wired into prototype (from TASK-033)
- Pilot restaurants are identified
- Initial configs have been generated
- Need refinement process and regression tests

**Prerequisites**: TASK-033 must be completed

## Checklist

### Preparation and Setup

- [ ] Review pilot restaurant configs from TASK-033
- [ ] Review Owner.com-style expectations from master plan
- [ ] Identify discrepancies and areas for improvement
- [ ] Plan refinement workflow
- [ ] Plan regression test strategy

### Implementation Steps

- [ ] Step 1: Create refinement workflow
  - [ ] Create `src/restaurant_site_planner/refinement/` directory
  - [ ] Create `src/restaurant_site_planner/refinement/__init__.py`
  - [ ] Create `src/restaurant_site_planner/refinement/process.py`
  - [ ] Add `refine_pilot_restaurant(restaurant: Restaurant, expected_patterns: Dict) -> RefinementResult` function
- [ ] Step 2: Implement comparison logic
  - [ ] Add comparison functions:
    - [ ] `compare_with_owner_patterns(config: PageConfig, expected: Dict) -> List[Discrepancy]`
    - [ ] Compare SEO metadata patterns
    - [ ] Compare heading structures
    - [ ] Compare section ordering
    - [ ] Compare CTA placement
    - [ ] Compare theme application
  - [ ] Generate discrepancy report with:
    - [ ] Discrepancy type
    - [ ] Current value
    - [ ] Expected value
    - [ ] Suggested fix
- [ ] Step 3: Implement refinement actions
  - [ ] For each pilot restaurant:
    - [ ] Generate configs using current builders
    - [ ] Compare with Owner.com-style expectations
    - [ ] Identify discrepancies
    - [ ] Update mapping rules if needed:
      - [ ] Theme selection rules
      - [ ] SEO template rules
      - [ ] Heading structure rules
      - [ ] Section ordering rules
    - [ ] Update templates if needed:
      - [ ] SEO metadata templates
      - [ ] Heading templates
      - [ ] Section templates
    - [ ] Regenerate configs with updated rules
    - [ ] Verify improvements
- [ ] Step 4: Create regression test framework
  - [ ] Add `tests/integration/test_pilot_refinement.py`
  - [ ] For each pilot restaurant:
    - [ ] Create test that generates configs
    - [ ] Assert configs meet Owner.com-style expectations
    - [ ] Assert specific patterns are followed
  - [ ] Add regression tests for bugs discovered:
    - [ ] Create test case for each bug
    - [ ] Ensure bug doesn't recur
- [ ] Step 5: Document refinement process
  - [ ] Create refinement checklist
  - [ ] Document common discrepancies and fixes
  - [ ] Document mapping rule updates
  - [ ] Create refinement log/notes

### Specific Requirements

- [ ] Requirement 1: Refinement process is repeatable
  - [ ] Can run for multiple pilot restaurants
  - [ ] Results are consistent
  - [ ] Changes are tracked
- [ ] Requirement 2: Regression tests prevent regressions
  - [ ] Tests cover all pilot restaurants
  - [ ] Tests cover discovered bugs
  - [ ] Tests are maintained as system evolves
- [ ] Requirement 3: Improvements are measurable
  - [ ] Can compare before/after configs
  - [ ] Can track improvement metrics
  - [ ] Can verify Owner.com alignment

### Error Handling and Edge Cases

- [ ] Handle error case 1: Pilot restaurant with incomplete data
  - [ ] Gracefully handle missing fields
  - [ ] Document data requirements
- [ ] Handle error case 2: Config generation failures
  - [ ] Catch and log errors
  - [ ] Continue with other pilot restaurants
- [ ] Handle edge case 1: Conflicting expectations
  - [ ] Prioritize Owner.com patterns
  - [ ] Document decisions
- [ ] Handle edge case 2: Edge cases in pilot data
  - [ ] Handle unusual restaurant configurations
  - [ ] Add tests for edge cases

### Testing

- [ ] Write integration tests: `tests/integration/test_pilot_refinement.py`
  - [ ] Test refinement process for each pilot restaurant
  - [ ] Test config generation for pilot restaurants
  - [ ] Test comparison with Owner.com patterns
  - [ ] Test regression tests for discovered bugs
  - [ ] Test that refinements improve configs
  - [ ] Backfill regression tests for any bug/edge case discovered during pilot integrations
- [ ] Write unit tests for refinement functions
  - [ ] Test comparison logic
  - [ ] Test discrepancy detection
  - [ ] Test refinement actions
- [ ] Run full test suite: `pytest tests/integration/test_pilot_refinement.py`
- [ ] Verify test coverage: `pytest --cov=restaurant_site_planner.refinement`

### Documentation

- [ ] Document refinement process
- [ ] Document common discrepancies and fixes
- [ ] Document mapping rule updates
- [ ] Create refinement log
- [ ] Document regression test strategy

### Verification

- [ ] Verify refinement process works
- [ ] Verify regression tests prevent regressions
- [ ] Verify improvements are measurable
- [ ] Verify no regressions

## Notes

- This task is part of Phase 3: Owner.com-Aligned Restaurant Sites
- **Execution Timing**: After TASK-033
- **Dependencies**: 
  - TASK-033: Prototype integration must be complete
- **Important Considerations**: 
  - This is an iterative, ongoing process
  - Refinement should be data-driven
  - Regression tests are critical
  - Document all changes and rationale
- **Task Independence**: Must be developed after TASK-033

## Related Tasks

- Previous: TASK-033 (Prototype integration)
- Next: None (final task)
- Dependencies:
  - TASK-033
- Related:
  - All previous tasks (refinement affects all components)

## Definition of Done

### Task Type: CODE/FILE WRITING TASK

**User Stories**:
1. **As a developer**, I want a refinement process so I can improve configs based on real-world usage
2. **As a QA engineer**, I want regression tests so bugs don't recur
3. **As a product manager**, I want measurable improvements so I can track progress toward Owner.com alignment

**Automated Tests**:
- [ ] Integration tests exist: `tests/integration/test_pilot_refinement.py`
- [ ] All tests pass: `pytest tests/integration/test_pilot_refinement.py` exits with code 0
- [ ] Regression tests backfilled for any bug/edge case discovered during pilot integrations
- [ ] Tests verify refinement process works for pilot restaurants
- [ ] Test coverage >= 80%

**Code Quality**:
- [ ] Refinement process is well-documented
- [ ] Regression tests are comprehensive
- [ ] Code follows Python style guidelines

**Git & Version Control**:
- [ ] All new files are added to git: `git add .`
- [ ] Changes are committed: `git commit -m "TASK-034: Implement iterative refinement loop"`
- [ ] Code is pushed to origin: `git push origin <branch-name>`
- [ ] Commit message includes task ID: TASK-034

**Final Verification**:
- [ ] All checklist items completed
- [ ] All tests pass
- [ ] Refinement process is working
- [ ] Regression tests are in place
- [ ] Code committed and pushed
