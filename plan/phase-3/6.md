# TASK-006: Implement Theme Serialization & Selection

**Section**: 1. Theme System & Style Families
**Subsection**: 1.3
**Task ID**: TASK-006

## Description

Add helper functions for theme serialization and automatic theme family selection based on restaurant cuisine. This includes serializing themes to JSON files and mapping restaurant cuisines to appropriate theme families (e.g. sushi → modern Asian, pizza → warm casual).

**Reference Implementation**: `menuhq/restaurant-finder/plan/phase-3/master-plan.md` (Section 2)

## Current State

- RestaurantTheme schema exists (TASK-004)
- Theme families exist (TASK-005)
- No serialization helpers exist
- No cuisine-to-family mapping exists

**Prerequisites**: TASK-004 and TASK-005 must be completed

## Checklist

### Preparation and Setup

- [ ] Review theme families from TASK-005
- [ ] Plan cuisine-to-family mapping rules
- [ ] Plan serialization format (JSON)

### Implementation Steps

- [ ] Step 1: Create theme utilities module
  - [ ] Create `src/restaurant_site_planner/themes/utils.py`
- [ ] Step 2: Implement theme serialization
  - [ ] Add `serialize_theme_to_json(theme: RestaurantTheme) -> str` function
  - [ ] Add `save_theme_to_file(theme: RestaurantTheme, filepath: str)` function
  - [ ] Ensure JSON is pretty-printed and human-readable
- [ ] Step 3: Implement theme deserialization
  - [ ] Add `load_theme_from_json(json_str: str) -> RestaurantTheme` function
  - [ ] Add `load_theme_from_file(filepath: str) -> RestaurantTheme` function
  - [ ] Handle validation errors gracefully
- [ ] Step 4: Implement cuisine-to-family mapping
  - [ ] Add `select_theme_family_for_cuisine(cuisine: str) -> str` function
  - [ ] Map cuisines to families:
    - [ ] Sushi, Japanese, Asian → "modern-asian-sushi"
    - [ ] Pizza, Italian, Bistro → "warm-casual-pizza"
    - [ ] Breakfast, Diner, Comfort → "breakfast-diner"
    - [ ] Fast-casual, Street Food, Mexican, Greek → "fast-casual-street-food"
    - [ ] Default → "warm-casual-pizza"
  - [ ] Handle case-insensitive matching
  - [ ] Handle multiple cuisines (use first match or most specific)
- [ ] Step 5: Implement theme factory selector
  - [ ] Add `get_theme_for_restaurant(restaurant: Restaurant) -> RestaurantTheme` function
  - [ ] Uses cuisine to select family
  - [ ] Returns theme from appropriate factory
  - [ ] Handles restaurants with no cuisine (default theme)

### Specific Requirements

- [ ] Requirement 1: Round-trip serialization works
  - [ ] Theme → JSON → Theme preserves all data
  - [ ] No data loss in serialization
- [ ] Requirement 2: Cuisine mapping is accurate
  - [ ] Common cuisines map to expected families
  - [ ] Edge cases handled (unknown cuisines, multiple cuisines)

### Error Handling and Edge Cases

- [ ] Handle error case 1: Invalid JSON in deserialization
  - [ ] Clear error message
  - [ ] Validation errors are caught
- [ ] Handle edge case 1: Restaurant with no cuisine
  - [ ] Default to warm-casual-pizza family
- [ ] Handle edge case 2: Unknown cuisine
  - [ ] Default to warm-casual-pizza family
- [ ] Handle edge case 3: Multiple cuisines
  - [ ] Use first cuisine or most specific match

### Testing

- [ ] Write unit tests: `tests/test_theme_utils.py`
  - [ ] Test `serialize_theme_to_json()` produces valid JSON
  - [ ] Test `load_theme_from_json()` parses JSON correctly
  - [ ] Test round-trip: Theme → JSON → Theme (data preservation)
  - [ ] Test `save_theme_to_file()` and `load_theme_from_file()`
  - [ ] Test `select_theme_family_for_cuisine()` for various cuisines
  - [ ] Test sushi → modern-asian-sushi
  - [ ] Test pizza → warm-casual-pizza
  - [ ] Test breakfast → breakfast-diner
  - [ ] Test fast-casual → fast-casual-street-food
  - [ ] Test unknown cuisine → default
  - [ ] Test `get_theme_for_restaurant()` with sample restaurants
- [ ] Run full test suite: `pytest tests/test_theme_utils.py`
- [ ] Verify test coverage: `pytest --cov=restaurant_site_planner.themes.utils`

### Documentation

- [ ] Add docstrings to all utility functions
- [ ] Document cuisine mapping rules
- [ ] Add usage examples

### Verification

- [ ] Verify serialization works
- [ ] Verify cuisine mapping works
- [ ] Verify no regressions

## Notes

- This task is part of Phase 3: Owner.com-Aligned Restaurant Sites
- **Execution Timing**: After TASK-005
- **Dependencies**: TASK-004, TASK-005
- **Important Considerations**: 
  - Cuisine mapping should be extensible
  - Consider making mapping configurable
- **Task Independence**: Can be developed after TASK-005

## Related Tasks

- Previous: TASK-005 (Theme families)
- Next: TASK-007 (URL builders)
- Dependencies: TASK-004, TASK-005
- Related: TASK-015 (Will use theme selection)

## Definition of Done

### Task Type: CODE/FILE WRITING TASK

**User Stories**:
1. **As a developer**, I want to serialize themes to JSON so I can save and share themes
2. **As a developer**, I want automatic theme selection based on cuisine so restaurants get appropriate themes
3. **As a developer**, I want round-trip serialization so themes can be saved and loaded

**Automated Tests**:
- [ ] Unit tests exist: `tests/test_theme_utils.py`
- [ ] All tests pass: `pytest tests/test_theme_utils.py` exits with code 0
- [ ] Round-trip serialization tests (theme → JSON → theme)
- [ ] Tests mapping sample restaurants to expected default theme family
- [ ] Test coverage >= 85%

**Code Quality**:
- [ ] All functions have type hints
- [ ] Error handling is implemented
- [ ] Code follows Python style guidelines

**Git & Version Control**:
- [ ] All files added to git
- [ ] Committed: `git commit -m "TASK-006: Implement theme serialization & selection"`
- [ ] Pushed to origin
- [ ] Commit includes task ID

**Final Verification**:
- [ ] All checklist items completed
- [ ] All tests pass
- [ ] Serialization works correctly
- [ ] Cuisine mapping works correctly
- [ ] Code committed and pushed
